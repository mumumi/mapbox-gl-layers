(function(o,c){typeof exports=="object"&&typeof module!="undefined"?c(exports,require("echarts"),require("arrugator"),require("proj4")):typeof define=="function"&&define.amd?define(["exports","echarts","arrugator","proj4"],c):(o=typeof globalThis!="undefined"?globalThis:o||self,c(o.MapboxGLExLayers={},o.echarts,o.Arrugator,o.proj4))})(this,function(o,c,v,A){"use strict";function f(r){return r&&typeof r=="object"&&"default"in r?r:{default:r}}function R(r){if(r&&r.__esModule)return r;var t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});return r&&Object.keys(r).forEach(function(e){if(e!=="default"){var i=Object.getOwnPropertyDescriptor(r,e);Object.defineProperty(t,e,i.get?i:{enumerable:!0,get:function(){return r[e]}})}}),t.default=r,Object.freeze(t)}var d=R(c),S=f(v),y=f(A);const m="mapboxgl-echarts";class h{constructor(t){this.dimensions=["x","y"],this._mapOffset=[0,0],this.map=t}create(t){t.eachSeries(e=>{e.get("coordinateSystem")===m&&(e.coordinateSystem=new h(this.map))})}dataToPoint(t){const e=this.map.project(t),i=this._mapOffset;return[e.x-i[0],e.y-i[1]]}pointToData(t){const e=this._mapOffset,i=this.map.unproject([t[0]+e[0],t[1]+e[1]]);return[i.lng,i.lat]}}class x{constructor(t,e){this._registered=!1,this.id=t,this.type="custom",this.renderingMode="2d",this._coordSystemName=m,this._ecOption=e}onAdd(t){this._map=t,this._createLayerContainer()}onRemove(){var t;(t=this._ec)==null||t.dispose(),this._removeLayerContainer()}setOption(t){var e;(e=this._ec)==null||e.setOption(t)}render(){this._container||this._createLayerContainer(),this._ec?this._map.isMoving()?this._ec.clear():(this._ec.resize({width:this._map.getCanvas().width,height:this._map.getCanvas().height}),this._ec.setOption(this._ecOption)):(this._ec=d.init(this._container),this._prepareECharts(),this._ec.setOption(this._ecOption))}_prepareECharts(){if(!this._registered){const e=new h(this._map);d.registerCoordinateSystem(this._coordSystemName,e),this._registered=!0}const t=this._ecOption.series;if(t)for(let e=t.length-1;e>=0;e--)t[e].coordinateSystem=this._coordSystemName}_createLayerContainer(){const t=this._map.getCanvasContainer();this._container=document.createElement("div"),this._container.style.width=this._map.getCanvas().style.width,this._container.style.height=this._map.getCanvas().style.height,t.appendChild(this._container)}_removeLayerContainer(){var t;this._container&&((t=this._container.parentNode)==null||t.removeChild(this._container))}}function b(r){return new Promise((t,e)=>{const i=new Image;i.src=r,i.onload=function(){t(i)},i.onerror=function(){e("error")}})}function p(r,t,e){const i=r.createShader(t);if(i==null)return console.log("unable to create shader"),null;if(r.shaderSource(i,e),r.compileShader(i),!r.getShaderParameter(i,r.COMPILE_STATUS)){const a=r.getShaderInfoLog(i);return console.log("Failed to compile shader: "+a),r.deleteShader(i),null}return i}function l(r,t,e){const i=p(r,r.VERTEX_SHADER,t),n=p(r,r.FRAGMENT_SHADER,e);if(!i||!n)return null;const a=r.createProgram();if(!a)return null;if(r.attachShader(a,i),r.attachShader(a,n),r.linkProgram(a),!r.getProgramParameter(a,r.LINK_STATUS)){const _=r.getProgramInfoLog(a);return console.log("Failed to link program: "+_),r.deleteProgram(a),r.deleteShader(n),r.deleteShader(i),null}return a}class L{constructor(t,e){this.id=t,this.type="custom",this.renderingMode="2d",this._option=e,this._loaded=!1;const{projection:i,coordinates:n}=e,a=this._initArrugator(i,n);this._arrugado={pos:a.projected.flat(),uv:a.uv.flat(),trigs:a.trigs.flat()},this._program=null,this._texture=null,this._verticesIndexBuffer=null}onAdd(t,e){b(this._option.url).then(a=>{this._loaded=!0,this._texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this._texture);const s=this._option.resampling==="nearest"?e.NEAREST:e.LINEAR;e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,a),t.triggerRepaint()});const i=`
      uniform mat4 u_matrix;
      attribute vec2 a_pos;
      attribute vec2 a_uv;
      varying vec2 v_uv;
      void main() {
        gl_Position = u_matrix * vec4(a_pos, 0.0, 1.0);
        v_uv = a_uv;
      }`,n=`
      #ifdef GL_ES
        precision highp int;
        precision mediump float;
      #endif
      uniform sampler2D u_sampler;
      varying vec2 v_uv;
      void main() {
        gl_FragColor = texture2D(u_sampler, v_uv);
      }`;if(this._program=l(e,i,n),this._program){const a=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this._arrugado.pos),e.STATIC_DRAW);const s=e.getAttribLocation(this._program,"a_pos");s<0&&console.log("Failed to get the storage location of a_pos"),e.vertexAttribPointer(s,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(s);const _=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,_),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this._arrugado.uv),e.STATIC_DRAW);const u=e.getAttribLocation(this._program,"a_uv");u<0&&console.log("Failed to get the storage location of a_uv"),e.vertexAttribPointer(u,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(u),this._verticesIndexBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._verticesIndexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(this._arrugado.trigs),e.STATIC_DRAW)}}onRemove(t,e){e.deleteProgram(this._program),e.deleteTexture(this._texture),e.deleteBuffer(this._verticesIndexBuffer)}render(t,e){this._loaded&&this._program&&(t.useProgram(this._program),t.uniformMatrix4fv(t.getUniformLocation(this._program,"u_matrix"),!1,e),t.activeTexture(t.TEXTURE10),t.bindTexture(t.TEXTURE_2D,this._texture),t.uniform1i(t.getUniformLocation(this._program,"u_sampler"),10),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._verticesIndexBuffer),t.drawElements(t.TRIANGLES,this._arrugado.trigs.length,t.UNSIGNED_SHORT,0))}_initArrugator(t,e){const i=[-20037508342789244e-9,20037508342789244e-9],n=[e[0],e[3],e[1],e[2]],a=y.default(t,"EPSG:3857").forward;function s(O){const T=a(O),P=Math.abs((T[0]-i[0])/(20037508342789244e-9*2)),F=Math.abs((T[1]-i[1])/(20037508342789244e-9*2));return[P,F]}const _=1e-11,u=[[0,0],[0,1],[1,0],[1,1]],E=new S.default(s,n,u,[[0,1,3],[0,3,2]]);return E.lowerEpsilon(_),E.output()}}o.EChartsLayer=x,o.ImageLayer=L,Object.defineProperties(o,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
